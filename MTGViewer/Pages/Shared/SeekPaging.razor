@inject NavigationManager Nav
@using System.Paging.Query

@if (HasPrevious || HasNext)
{
    <nav>
        <ul class="pagination justify-content-center">
            @if (HasPrevious && ChangePage.HasDelegate)
            {
                <li class="page-item">
                    <button title="Previous Page" class="page-link"
                        @onclick="PreviousPageAsync" disabled="@IsDisabled">
                        Previous
                    </button>
                </li>
            }
            else if (HasPrevious && !IsDisabled)
            {
                <li class="page-item">
                    <a title="First Page" href="@FirstUrl()" class="page-link"> First </a>
                </li>

                <li class="page-item">
                    <a title="Previous Page" href="@PreviousUrl()" class="page-link"> Previous </a>
                </li>
            }
            else
            {
                <li class="page-item disabled">
                    <span title="First Page" class="page-link disabled"> First </span>
                </li>

                <li class="page-item disabled">
                    <span title="Previous Page" class="page-link disabled"> Previous </span>
                </li>
            }

            @if (HasNext && ChangePage.HasDelegate)
            {
                <li class="page-item ">
                    <button title="Next Page" class="page-link"
                        @onclick="NextPageAsync" disabled="@IsDisabled">
                        Next
                    </button>
                </li>
            }
            else if (HasNext && !IsDisabled)
            {
                <li class="page-item ">
                    <a title="Next Page" href="@NextUrl()" class="page-link"> Next </a>
                </li>

                <li class="page-item">
                    <a title="Last Page" href="@LastUrl()" class="page-link"> Last </a>
                </li>
            }
            else
            {
                <li class="page-item disabled">
                    <span title="Next Page" class="page-link"> Next </span>
                </li>

                <li class="page-item disabled">
                    <span title="Next Page" class="page-link"> Last </span>
                </li>
            }
        </ul>
    </nav>
}


@code 
{
    [Parameter]
    public Seek Seek { get; set; }

    [Parameter]
    public EventCallback<object> ChangePage { get; set; }

    [Parameter]
    public bool IsDisabled { get; set; }

    public bool HasPrevious => Seek.Previous is not null;

    public bool HasNext => Seek.Next is not null;


    private bool _isBusy;


    private static readonly Dictionary<string, object?> _first = new()
    {
        ["direction"] = SeekDirection.Forward,
        ["seek"] = null
    };

    private readonly Dictionary<string, object?> _previous = new()
    {
        ["direction"] = SeekDirection.Backwards,
    };

    private readonly Dictionary<string, object?> _next = new()
    {
        ["direction"] = SeekDirection.Forward,
    };

    private static readonly Dictionary<string, object?> _last = new()
    {
        ["direction"] = SeekDirection.Backwards,
        ["seek"] = null
    };


    protected override void OnParametersSet()
    {
        _previous["seek"] = GetKey(Seek.Previous);
        _next["seek"] = GetKey(Seek.Next);
    }


    private object? GetKey(object? value)
    {
        if (value is null)
        {
            return null;
        }

        var keyProperty = ExpressionHelpers.GetKeyProperty(value.GetType());

        return keyProperty?.GetValue(value);
    }


    public string FirstUrl() =>
        Nav.GetUriWithQueryParameters(_first);

    public string PreviousUrl() =>
        Nav.GetUriWithQueryParameters(_previous);

    public string NextUrl() =>
        Nav.GetUriWithQueryParameters(_next);

    public string LastUrl() =>
        Nav.GetUriWithQueryParameters(_last);


    public async Task PreviousPageAsync()
    {
        if (_isBusy || GetKey(Seek.Previous) is not object current)
        {
            return;
        }

        _isBusy = true;

        try
        {
            await ChangePage.InvokeAsync(current);
        }
        finally
        {
            _isBusy = false;
        }
    }


    public async Task NextPageAsync()
    {
        if (_isBusy || GetKey(Seek.Next) is not object next)
        {
            return;
        }

        _isBusy = true;

        try
        {
            await ChangePage.InvokeAsync(next);
        }
        finally
        {
            _isBusy = false;
        }
    }

}